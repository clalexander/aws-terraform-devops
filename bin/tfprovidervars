#!/bin/bash
set -e

parent_path=$( cd "$(dirname "${BASH_SOURCE[0]}")" ; pwd -P )

# load utils
source $parent_path/utils

# get access keys and region from profile
if [[ ! -z "$AWS_PROFILE" ]]; then 
  AWS_ACCESS_KEY_ID=$(aws configure get aws_access_key_id --profile=$PROFILE)
  AWS_SECRET_ACCESS_KEY=$(aws configure get aws_secret_access_key --profile=$PROFILE)
  AWS_DEFAULT_REGION=$(aws configure get region --profile=$PROFILE)
fi

AWS_REGION=${AWS_REGION:-$AWS_DEFAULT_REGION}

# get remote state access keys and region from profile
if [[ ! -z "$REMOTE_STATE_AWS_PROFILE" ]]; then 
  REMOTE_STATE_ACCESS_KEY=$(aws configure get aws_access_key_id --profile=$REMOTE_STATE_PROFILE)
  REMOTE_STATE_SECRET_KEY=$(aws configure get aws_secret_access_key --profile=$REMOTE_STATE_PROFILE)
  REMOTE_STATE_DEFAULT_REGION=$(aws configure get region --profile=$REMOTE_STATE_PROFILE)
fi

REMOTE_STATE_REGION=${REMOTE_STATE_REGION:-$REMOTE_STATE_AWS_DEFAULT_REGION}

# get remote state key
remote_state_key=$($parent_path/tfkey)

# validate all variables are set
if [[ -z "$AWS_ACCESS_KEY_ID" ]]; then
  fail "Error missing AWS_ACCESS_KEY_ID environment variable, or set PROFILE environment variable to load from aws cli!"
fi
if [[ -z "$AWS_SECRET_ACCESS_KEY" ]]; then
  fail "Error missing AWS_SECRET_ACCESS_KEY environment variable, or set PROFILE environment variable to load from aws cli!"
fi
if [[ -z "$AWS_REGION" ]]; then
  fail "Error missing AWS_REGION environment variable, or set PROFILE environment variable to load from aws cli!"
fi
if [[ -z "$REMOTE_STATE_ACCESS_KEY" ]]; then
  fail "Error missing REMOTE_STATE_ACCESS_KEY environment variable, or set REMOTE_STATE_PROFILE environment variable to load from aws cli!"
fi
if [[ -z "$REMOTE_STATE_SECRET_KEY" ]]; then
  fail "Error missing REMOTE_STATE_SECRET_KEY environment variable, or set REMOTE_STATE_PROFILE environment variable to load from aws cli!"
fi
if [[ -z "$REMOTE_STATE_REGION" ]]; then
  fail "Error missing REMOTE_STATE_REGION environment variable, or set REMOTE_STATE_PROFILE environment variable to load from aws cli!"
fi
if [[ -z "$REMOTE_STATE_BUCKET" ]]; then
  fail "Error missing REMOTE_STATE_BUCKET environment variable!"
fi
if [[ -z "$REMOTE_STATE_LOCK_TABLE" ]]; then
  fail "Error missing REMOTE_STATE_LOCK_TABLE environment variable!"
fi

# export terraform vars
export TF_VAR_remote_state_access_key=$REMOTE_STATE_ACCESS_KEY
export TF_VAR_remote_state_secret_key=$REMOTE_STATE_SECRET_KEY
export TF_VAR_remote_state_region=$REMOTE_STATE_REGION
export TF_VAR_remote_state_bucket=$REMOTE_STATE_BUCKET
export TF_VAR_remote_state_key=$remote_state_key
export TF_VAR_remote_state_lock_table=$REMOTE_STATE_LOCK_TABLE
export TF_VAR_aws_region=$AWS_REGION
